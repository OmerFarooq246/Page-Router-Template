name: Deploy NextJs on Main Updates

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy-nextjs:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            APP_PATH="${{ secrets.APPS_FOLDER }}/${{ secrets.APP_NAME }}"

            # Clone or pull repo
            if [ ! -d "$APP_PATH/.git" ]; then
              echo "Repo not found. Cloning..."
              cd "${{ secrets.APPS_FOLDER }}"
              git clone "${{ secrets.REPO_URL }}" "${{ secrets.APP_NAME }}"
            else
              echo "Repo exists. Pulling latest changes..."
              cd "$APP_PATH"
              git pull
            fi

            cd "$APP_PATH"

            # Install Node and PM2
            sudo apt update
            sudo apt install -y nodejs npm
            sudo npm install -g pm2

            # Install dependencies
            npm install

            # Build Next.js
            npm run build

            # Start or restart PM2 process
            if pm2 list | grep -q "${{ secrets.APP_NAME }}"; then
              echo "Restarting PM2 app..."
              pm2 restart "${{ secrets.APP_NAME }}"
            else
              echo "Starting PM2 app..."
              pm2 start npm --name "${{ secrets.APP_NAME }}" -- run start -- -p ${{ secrets.PORT }}
            fi

            # Save PM2 process list (survives reboot)
            pm2 save
